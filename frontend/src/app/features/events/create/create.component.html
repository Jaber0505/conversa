<shared-container>
  <!-- En-tête avec bouton retour -->
  <shared-headline-bar
    [title]="'events.create.title' | t"
    [actionLabel]="'common.back' | t"
    (action)="goBack()">
  </shared-headline-bar>

  <!-- Indicateur d'étape -->
  <div class="stepper">
    <div *ngFor="let step of [1, 2, 3, 4, 5]"
         class="stepper-step"
         [class.active]="currentStep() === step"
         [class.completed]="currentStep() > step"
         (click)="goToStep(step)">
      <div class="step-number">{{ step }}</div>
      <div class="step-label">{{ 'events.create.step' + step | t }}</div>
    </div>
  </div>

  <!-- Formulaire -->
  <form [formGroup]="eventForm" (ngSubmit)="createEvent()">

    <!-- Étape 1: Sélection du lieu -->
    <shared-section *ngIf="currentStep() === 1" spacing="md">
      <h2 class="step-title">{{ 'events.create.step1_heading' | t }}</h2>
      <p class="step-description">{{ 'events.create.step1_description' | t }}</p>

      <!-- Champ de recherche par code postal -->
      <div class="search-field">
        <shared-input
          [label]="'events.create.postal_code' | t"
          [placeholder]="'events.create.postal_code_placeholder' | t"
          type="text"
          [value]="postalCode"
          (valueChange)="onPostalCodeChange($event)">
        </shared-input>
      </div>

      <!-- Grille de partners -->
      <div class="partners-grid" *ngIf="partners().length > 0">
        <shared-card
          *ngFor="let partner of getPaginatedPartners()"
          [class.selected]="selectedPartner()?.id === partner.id">
          <div class="partner-card">
            <h3 class="partner-name">{{ partner.name }}</h3>
            <p class="partner-address">{{ partner.address }}</p>
            <p class="partner-city">{{ partner.postal_code }} {{ partner.city }}</p>
            <p class="partner-capacity">
              <span class="capacity-icon">👥</span>
              {{ 'events.create.capacity' | t }}: {{ partner.capacity }}
            </p>

            <shared-badge variant="accent" tone="soft" *ngIf="selectedPartner()?.id === partner.id">
              {{ 'common.selected' | t }}
            </shared-badge>

            <div class="partner-actions">
              <shared-button
                variant="outline"
                size="sm"
                (click)="viewPartnerDetails(partner.id, $event)">
                {{ 'events.create.view_details' | t }}
              </shared-button>
              <shared-button
                [variant]="selectedPartner()?.id === partner.id ? 'accent' : 'primary'"
                size="sm"
                (click)="selectPartner(partner)">
                {{ selectedPartner()?.id === partner.id ? ('common.selected' | t) : ('events.create.select' | t) }}
              </shared-button>
            </div>
          </div>
        </shared-card>
      </div>

      <div class="partners-pagination" *ngIf="getPartnerTotalPages() > 1">
        <button
          type="button"
          class="pagination-button"
          [disabled]="partnersCurrentPage() === 1"
          (click)="goToPartnerPage(partnersCurrentPage() - 1)">
          ← {{ 'events.create.pagination.previous' | t }}
        </button>

        <div class="pagination-pages">
          <ng-container *ngFor="let item of getPartnerPaginationItems()">
            <button
              *ngIf="item.type === 'page'"
              type="button"
              class="pagination-page"
              [class.active]="partnersCurrentPage() === item.value"
              (click)="goToPartnerPage(item.value)">
              {{ item.value }}
            </button>
            <span
              *ngIf="item.type === 'ellipsis'"
              class="pagination-ellipsis">…</span>
          </ng-container>
        </div>

        <button
          type="button"
          class="pagination-button"
          [disabled]="partnersCurrentPage() === getPartnerTotalPages()"
          (click)="goToPartnerPage(partnersCurrentPage() + 1)">
          {{ 'events.create.pagination.next' | t }} →
        </button>
      </div>

      <div *ngIf="partnersLoading()" class="partners-loading">
        {{ 'common.loading' | t }}
      </div>

      <div *ngIf="partners().length === 0 && !partnersLoading()" class="empty-state">
        <p>{{ 'events.create.no_partners' | t }}</p>
      </div>
    </shared-section>

    <!-- Étape 2: Détails de l'événement -->
    <shared-section *ngIf="currentStep() === 2" spacing="md">
      <h2 class="step-title">{{ 'events.create.step2_heading' | t }}</h2>
      <p class="step-description">{{ 'events.create.step2_description' | t }}</p>

      <div class="form-fields">
        <!-- Langue -->
        <div class="form-group">
          <label>{{ 'events.create.language' | t }}</label>
          <shared-select
            [placeholder]="'events.create.select_language' | t"
            [options]="languageOptions()"
            [value]="selectedLanguageValue"
            (valueChange)="onLanguageChange($event)">
          </shared-select>
        </div>

        <!-- Thème -->
        <div class="form-group">
          <shared-input
            [label]="'events.create.theme' | t"
            [placeholder]="'events.create.theme_placeholder' | t"
            type="text"
            formControlName="theme"
            [errorMessage]="!!(eventForm.get('theme')?.invalid && eventForm.get('theme')?.touched)">
          </shared-input>
        </div>

        <!-- Niveau de difficulté -->
        <div class="form-group">
          <label>{{ 'events.create.difficulty' | t }}</label>
          <shared-select
            [placeholder]="'events.create.select_difficulty' | t"
            [options]="difficultyOptions()"
            [value]="selectedDifficultyValue"
            (valueChange)="onDifficultyChange($event)">
          </shared-select>
        </div>
      </div>
    </shared-section>

    <!-- Étape 3: Date et heure -->
    <shared-section *ngIf="currentStep() === 3" spacing="md">
      <h2 class="step-title">{{ 'events.create.step3_heading' | t }}</h2>
      <p class="step-description ux-text">
        {{ 'events.create.step3_description_full' | t }}
      </p>

      <!-- Sélecteur de jours -->
      <div class="days-selector">
        <div
          *ngFor="let day of availableDays()"
          class="day-card"
          [class.selected]="selectedDay()?.dateString === day.dateString"
          (click)="selectDay(day)">
          <div class="day-header">
            <span class="day-date">{{ day.formattedDate }}</span>
          <shared-badge variant="accent" tone="soft" *ngIf="day.isToday">
            {{ 'events.create.day.today' | t }}
          </shared-badge>
          <shared-badge variant="accent" tone="soft" *ngIf="day.isTomorrow">
            {{ 'events.create.day.tomorrow' | t }}
          </shared-badge>
          </div>

          <!-- Créneaux horaires pour ce jour -->
          <div class="time-slots">
            <button
              *ngFor="let slot of availableTimeSlots"
              type="button"
              class="time-slot-btn"
              [class.disabled]="!isTimeSlotAvailable(day, slot)"
              [class.active]="isTimeSlotSelected(day, slot)"
              [disabled]="!isTimeSlotAvailable(day, slot)"
              (click)="selectTimeSlot(day, slot); $event.stopPropagation()">
              {{ slot }}
            </button>
          </div>
        </div>
      </div>

      <!-- Message d'erreur si aucun créneau sélectionné -->
      <div *ngIf="!selectedTimeSlot() && eventForm.get('time')?.touched" class="error-message">
        {{ 'events.create.errors.slot_required' | t }}
      </div>
    </shared-section>

    <!-- Étape 4: Configuration du jeu -->
    <shared-section *ngIf="currentStep() === 4" spacing="md">
      <h2 class="step-title">{{ 'events.create.step4_heading' | t }}</h2>
      <p class="step-description">{{ 'events.create.step4_description' | t }}</p>

      <div class="form-fields">
        <!-- Type de jeu -->
        <div class="form-group">
          <label>{{ 'events.create.game_type' | t }}</label>
          <shared-select
            [placeholder]="'events.create.select_game_type' | t"
            [options]="gameTypeOptions()"
            [value]="selectedGameTypeValue"
            (valueChange)="onGameTypeChange($event)">
          </shared-select>
        </div>
      </div>
    </shared-section>

    <!-- Étape 5: Récapitulatif -->
    <shared-section *ngIf="currentStep() === 5" spacing="md">
      <h2 class="step-title">{{ 'events.create.step5_heading' | t }}</h2>
      <p class="step-description">{{ 'events.create.step5_description' | t }}</p>

      <shared-card>
        <div class="summary">
          <div class="summary-row">
            <span class="summary-label">{{ 'events.create.summary_location' | t }}:</span>
            <span class="summary-value">{{ selectedPartnerName }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">{{ 'events.create.summary_language' | t }}:</span>
            <span class="summary-value">{{ selectedLanguageName }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">{{ 'events.create.summary_theme' | t }}:</span>
            <span class="summary-value">{{ eventForm.get('theme')?.value }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">{{ 'events.create.summary_difficulty' | t }}:</span>
            <span class="summary-value">
              {{ 'events.difficulty.' + eventForm.get('difficulty')?.value | t }}
            </span>
          </div>
          <div class="summary-row">
            <span class="summary-label">{{ 'events.create.summary_datetime' | t }}:</span>
            <span class="summary-value">
              {{ eventForm.get('date')?.value }} {{ 'common.at' | t }} {{ eventForm.get('time')?.value }}
            </span>
          </div>
          <div class="summary-row">
            <span class="summary-label">{{ 'events.create.summary_game_type' | t }}:</span>
            <span class="summary-value">
              {{ 'games.types.' + eventForm.get('gameType')?.value | t }}
            </span>
          </div>
        </div>
      </shared-card>

      <shared-badge variant="danger" tone="soft" *ngIf="error() as err">
        {{ err | t }}
      </shared-badge>
    </shared-section>

    <!-- Navigation entre étapes -->
    <div class="step-navigation">
      <shared-button
        *ngIf="currentStep() > 1"
        variant="outline"
        (click)="prevStep()">
        {{ 'common.previous' | t }}
      </shared-button>

      <shared-button
        *ngIf="currentStep() < totalSteps"
        variant="primary"
        [disabled]="!canGoNext()"
        (click)="nextStep()">
        {{ 'common.next' | t }}
      </shared-button>

      <shared-button
        *ngIf="currentStep() === totalSteps"
        variant="accent"
        type="submit"
        [disabled]="!eventForm.valid || loading()">
        {{ loading() ? ('common.loading' | t) : ('events.create.create_draft' | t) }}
      </shared-button>
    </div>
  </form>
</shared-container>

<!-- Modal de choix de paiement -->
<app-payment-choice-modal
  [isOpen]="showPaymentModal()"
  [eventId]="createdEventId()"
  [eventPrice]="createdEventPrice()"
  (closeModal)="onClosePaymentModal()"
  (paymentSuccess)="onPaymentSuccess()"
  (payLater)="onPayLater()">
</app-payment-choice-modal>




