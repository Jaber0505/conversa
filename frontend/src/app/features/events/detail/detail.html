<div class="event-detail-page" *ngIf="!loading() && event() as evt">
  <div class="back-section">
    <shared-container>
      <button class="btn-back" (click)="goBack()">
        <span class="icon-arrow">â†</span>
        <span>{{ 'events.detail.back_to_events' | t }}</span>
      </button>
    </shared-container>
  </div>

  <shared-container>
    <shared-headline-bar [title]="evt.theme" [subtitle]="formatDate(evt.datetime_start) + ' Â· ' + (evt.partner_city || '')"></shared-headline-bar>

    <div class="status-badges">
      <shared-badge *ngIf="evt.status === 'DRAFT'" variant="muted" tone="soft">{{ 'events.draft' | t }}</shared-badge>
      <shared-badge *ngIf="evt.status === 'PENDING_CONFIRMATION'" variant="accent" tone="soft">{{ 'events.detail.status.pending_confirmation' | t }}</shared-badge>
      <shared-badge *ngIf="evt.status === 'PUBLISHED'" variant="success" tone="solid">{{ 'events.detail.status.published' | t }}</shared-badge>
      <shared-badge *ngIf="evt.status === 'CANCELLED'" variant="danger" tone="soft">{{ 'events.cancelled' | t }}</shared-badge>
      <shared-badge *ngIf="evt.status === 'FINISHED'" variant="muted" tone="soft">{{ 'events.detail.status.finished' | t }}</shared-badge>
      <shared-badge *ngIf="isOrganizer()" variant="accent" tone="soft">{{ 'events.detail.status.you_are_organizer' | t }}</shared-badge>
    </div>

    <!-- Checkbox Mode Test (visible uniquement pour l'organisateur) -->
    <div class="test-mode-container" *ngIf="isOrganizer() && evt.status === 'PUBLISHED' && evt.game_type">
      <label class="checkbox-label">
        <input
          type="checkbox"
          [checked]="skipTimeValidation()"
          (change)="skipTimeValidation.set($any($event.target).checked)"
        />
        <span>{{ 'events.detail.test_mode' | t }}</span>
      </label>
    </div>

    <div class="detail-grid">
      <div class="main-column">
        <div class="event-header">
          <div class="event-badges">
            <span class="badge badge-primary">{{ getLanguageLabel(evt) }}</span>
            <span class="badge badge-secondary">{{ 'events.difficulty.' + evt.difficulty | t }}</span>
          </div>

          <div class="event-meta">
            <div class="meta-item"><span>{{ formatDate(evt.datetime_start) }}</span></div>
            <div class="meta-item"><span>{{ formatTime(evt.datetime_start) }}</span></div>
            <div class="meta-item"><span>{{ evt.partner_address }}, {{ evt.partner_city }}</span></div>
          </div>
        </div>

        <div class="event-section">
          <h2 class="section-title">{{ 'events.detail.location' | t }}</h2>
          <div class="map-container">
            <iframe [src]="getGoogleMapsUrl(evt.partner_address + ', ' + evt.partner_city) | sanitizeUrl" width="100%" height="400" style="border:0;" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
          <p class="address-text"><strong>{{ evt.partner_name }}</strong><br>{{ evt.partner_address }}<br>{{ evt.partner_city }}</p>
        </div>

        <div class="event-section participants-section">
          <h2 class="section-title">{{ 'events.detail.participants' | t }}</h2>

          <ng-container *ngIf="participantsLoading(); else participantsContent">
            <p class="participants-message">{{ 'events.detail.participants_loading' | t }}</p>
          </ng-container>

          <ng-template #participantsContent>
            <p class="participants-message" *ngIf="participantsError()">{{ participantsError()! | t }}</p>
            <p class="participants-message" *ngIf="!participantsError() && !participants().length">
              {{ 'events.detail.no_participants_yet' | t }}
            </p>

            <div class="participants-list" *ngIf="!participantsError() && participants().length">
              <div class="participant-card" *ngFor="let participant of participants()">
                <div class="participant-name">
                  {{ participant.first_name }} {{ participant.last_name }}
                </div>
                <div class="participant-languages">
                  <div class="language-group" *ngIf="participant.native_languages?.length">
                    <span class="language-label">{{ 'events.detail.native_languages' | t }}</span>
                    <span class="language-values">{{ formatLanguages(participant.native_languages) }}</span>
                  </div>
                  <div class="language-group" *ngIf="participant.target_languages?.length">
                    <span class="language-label">{{ 'events.detail.target_languages' | t }}</span>
                    <span class="language-values">{{ formatLanguages(participant.target_languages) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </div>
      </div>

      <div class="sidebar-column">
        <div class="booking-card">
          <div class="price-section">
            <span class="price-label">{{ 'events.detail.price_per_person' | t }}</span>
            <span class="price-value">{{ formatPrice(evt.price_cents) }}</span>
          </div>

          <div class="organizer-section">
            <p class="organizer-label">{{ 'events.detail.organized_by' | t }}</p>
            <p class="organizer-name">{{ evt.organizer_first_name }} {{ evt.organizer_last_name }}</p>
          </div>

          <div class="availability-section" *ngIf="evt.status === 'PUBLISHED'">
            <div class="availability-bar">
              <div class="availability-fill" [style.width.%]="getAvailabilityPercent(evt)"></div>
            </div>
            <ng-container *ngIf="!isEventFull(evt); else eventFullLabel">
              <p class="availability-text">
                {{ evt.booked_seats || 0 }} / {{ evt.max_participants || evt.partner_capacity }} places
              </p>
            </ng-container>
            <ng-template #eventFullLabel>
              <p class="availability-text full">{{ 'events.detail.event_full' | t }}</p>
            </ng-template>
          </div>

          <!-- Nouveau composant EventActionButton -->
          <app-event-action-button
            [event]="evt"
            [userId]="currentUserId()"
            [isOrganizer]="isOrganizer()"
            [showBadge]="true"
            [primaryOnly]="false"
            [size]="'lg'"
            [loading]="startingGame() || cancellingBooking() || organizerPaymentLoading()"
            [hideViewDetails]="true"
            [skipTimeValidation]="skipTimeValidation()"
            (actionTriggered)="handleEventAction($event)"
          />
        </div>
      </div>
    </div>
  </shared-container>
</div>

<div class="loading-state" *ngIf="loading()">
  <shared-container>
    <div class="spinner"></div>
    <p>{{ 'events.detail.loading' | t }}</p>
  </shared-container>
</div>

<div class="error-state" *ngIf="error() && !loading()">
  <shared-container>
    <h2>{{ 'events.detail.not_found' | t }}</h2>
    <p>{{ error() }}</p>
    <shared-button (click)="goBack()">{{ 'events.detail.back_to_events' | t }}</shared-button>
  </shared-container>
</div>

<app-confirm-purchase *ngIf="showCancelModal()" [asModal]="true" [titleKey]="'events.detail.cancel_modal_title'" [messageKey]="'events.detail.cancel_modal_message'" [cancelKey]="'common.no'" [buyKey]="'events.detail.yes_cancel'" [loading]="cancellingBooking()" (cancel)="closeCancelModal()" (buy)="confirmCancelBooking()"></app-confirm-purchase>

<app-confirm-purchase *ngIf="showCancelEventModal()" [asModal]="true" [titleKey]="'events.detail.cancel_event_title'" [messageKey]="'events.detail.cancel_event_message'" [cancelKey]="'common.no'" [buyKey]="'events.detail.yes_cancel_event'" [loading]="cancellingEvent()" (cancel)="closeCancelEventModal()" (buy)="confirmCancelEvent()"></app-confirm-purchase>
