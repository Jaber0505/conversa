<shared-container>
  <shared-headline-bar
    [title]="'events.title' | t"
    [subtitle]="userCity ? ('events.near_city' | t:{ city: userCity }) : ''"
    [actionLabel]="'events.add_event' | t"
    [actionDisabled]="!canCreateEvent()"
    [actionTooltip]="createButtonTooltip()"
    (action)="onCreateEvent()">
  </shared-headline-bar>

  <!-- Filtres avanc√©s modernes -->
  <app-event-filters
    [languageOptions]="langOptions()"
    (filtersChanged)="onFiltersChanged($event)">
  </app-event-filters>

  <!-- Message d'erreur -->
  <div class="state-error" *ngIf="error() as err">
    <shared-badge variant="danger" tone="soft">{{ err | t }}</shared-badge>
  </div>

  <!-- √âtat vide -->
  <shared-empty-state
    *ngIf="myEvents().length === 0 && publicEvents().length === 0 && !error()"
    [icon]="'üîé'"
    [title]="'events.empty' | t"
    [subtitle]="'Essayez d\'ajuster vos filtres ou revenez plus tard'"
    [actionLabel]="(searchInput || selectedLangCodes.length > 0) ? ('events.filters.reset' | t) : null"
    (action)="resetSearch()">
  </shared-empty-state>

  <!-- Section "Mes √©v√©nements" -->
  <section class="my-events-section" *ngIf="myEvents().length > 0">
    <div class="section-header">
      <h2 class="section-title">{{ 'events.my_events' | t }}</h2>
      <button
        type="button"
        class="collapse-button"
        (click)="toggleMyEventsSection()"
        [attr.aria-expanded]="!isMyEventsSectionCollapsed()"
        [attr.aria-label]="isMyEventsSectionCollapsed() ? 'Afficher mes √©v√©nements' : 'Masquer mes √©v√©nements'">
        <span class="collapse-icon" [class.collapsed]="isMyEventsSectionCollapsed()">‚ñº</span>
      </button>
    </div>

    <div class="section-content" [class.collapsed]="isMyEventsSectionCollapsed()">
      <div class="events-grid">
        <app-event-card
          *ngFor="let scoredEvent of getPaginatedEvents(myEvents(), 'my'); trackBy: trackById"
          [event]="scoredEvent.event"
          [isNearby]="false"
          [isRecommended]="scoredEvent.isRecommended"
          [isOrganizer]="true"
          [showBookButton]="false"
          [priorityBadge]="scoredEvent.badgeReason"
          [isPaymentLoading]="paymentLoadingEventId() === scoredEvent.event.id"
          (book)="onBookEvent($event)"
          (viewDetails)="onViewDetails($event)"
          (payDraft)="onPayDraftNow($event)"
          (playGame)="onPlayGame($event)">
        </app-event-card>
      </div>

      <!-- Pagination for "Mes √©v√©nements" -->
      <div class="pagination" *ngIf="getTotalPages(myEvents()) > 1">
        <button
          type="button"
          class="pagination-button"
          [disabled]="myEventsCurrentPage() === 1"
          (click)="goToPage(myEventsCurrentPage() - 1, 'my', myEvents().length)">
          ‚Äπ Pr√©c√©dent
        </button>

      <div class="pagination-pages">
        <ng-container *ngFor="let item of getPaginationItems(myEvents(), 'my')">
          <button
            *ngIf="item.type === 'page'"
            type="button"
            class="pagination-page"
            [class.active]="myEventsCurrentPage() === item.value"
            (click)="goToPage(item.value, 'my', myEvents().length)">
            {{ item.value }}
          </button>
          <span
            *ngIf="item.type === 'ellipsis'"
            class="pagination-ellipsis">‚Ä¶</span>
        </ng-container>
      </div>

        <button
          type="button"
          class="pagination-button"
          [disabled]="myEventsCurrentPage() === getTotalPages(myEvents())"
          (click)="goToPage(myEventsCurrentPage() + 1, 'my', myEvents().length)">
          Suivant ‚Ä∫
        </button>
      </div>
    </div>
  </section>

  <!-- Section "Tous les √©v√©nements" -->
  <section class="public-events-section" *ngIf="publicEvents().length > 0">
    <h2 class="section-title">{{ 'events.all_events' | t }}</h2>
    <div class="events-grid">
      <app-event-card
        *ngFor="let scoredEvent of getPaginatedEvents(publicEvents(), 'public'); trackBy: trackById"
        [event]="scoredEvent.event"
        [isNearby]="scoredEvent.isNearby"
        [isRecommended]="scoredEvent.isRecommended"
        [priorityBadge]="scoredEvent.badgeReason"
        [isOrganizer]="false"
        [reserved]="scoredEvent.event.alreadyBooked === true"
        [showBookButton]="false"
        (book)="onBookEvent($event)"
        (viewDetails)="onViewDetails($event)"
        (playGame)="onPlayGame($event)">
      </app-event-card>
    </div>

    <!-- Pagination for "Tous les √©v√©nements" -->
    <div class="pagination" *ngIf="getTotalPages(publicEvents()) > 1">
      <button
        type="button"
        class="pagination-button"
        [disabled]="publicEventsCurrentPage() === 1"
        (click)="goToPage(publicEventsCurrentPage() - 1, 'public', publicEvents().length)">
        ‚Äπ Pr√©c√©dent
      </button>

      <div class="pagination-pages">
        <ng-container *ngFor="let item of getPaginationItems(publicEvents(), 'public')">
          <button
            *ngIf="item.type === 'page'"
            type="button"
            class="pagination-page"
            [class.active]="publicEventsCurrentPage() === item.value"
            (click)="goToPage(item.value, 'public', publicEvents().length)">
            {{ item.value }}
          </button>
          <span
            *ngIf="item.type === 'ellipsis'"
            class="pagination-ellipsis">‚Ä¶</span>
        </ng-container>
      </div>

      <button
        type="button"
        class="pagination-button"
        [disabled]="publicEventsCurrentPage() === getTotalPages(publicEvents())"
        (click)="goToPage(publicEventsCurrentPage() + 1, 'public', publicEvents().length)">
        Suivant ‚Ä∫
      </button>
    </div>
  </section>

  <!-- Compteur de r√©sultats -->
  <div class="results-count" *ngIf="myEvents().length > 0 || publicEvents().length > 0">
    <p class="count-text">
      {{ myEvents().length + publicEvents().length }} √©v√©nement{{ (myEvents().length + publicEvents().length) > 1 ? 's' : '' }} trouv√©{{ (myEvents().length + publicEvents().length) > 1 ? 's' : '' }}
    </p>
  </div>
</shared-container>

<!-- Modal de confirmation d'achat -->
<app-confirm-purchase
  *ngIf="confirmPopup"
  [titleKey]="'checkout.title'"
  [messageKey]="'checkout.message'"
  [buyKey]="'checkout.buy'"
  [cancelKey]="'common.cancel'"
  [priceCents]="getSelectedEventPrice()"
  [asModal]="true"
  (cancel)="closeDialog()"
  (buy)="performPurchase()">
</app-confirm-purchase>
