<shared-container>
  <shared-headline-bar
    [title]="'events.title' | t"
    [subtitle]="userCity ? ('events.near_city' | t:{ city: userCity }) : ''"
    [actionLabel]="'events.add_event' | t"
    [actionDisabled]="!canCreateEvent()"
    [actionTooltip]="createButtonTooltip()"
    (action)="onCreateEvent()">
  </shared-headline-bar>

  <!-- Barre de recherche et filtres -->
  <div class="search-section">
    <shared-search-bar
      [fields]="[
        { type: 'multiselect', placeholder: ('shared.search.select_placeholder' | t), options: langOptions(), width: '200px' },
        { type: 'text',        placeholder: ('shared.search.placeholder_event' | t), width: '1fr' }
      ]"
      [searchButtonText]="'shared.search.submit' | t"
      (search)="onSearchBar($event)">
    </shared-search-bar>
  </div>

  <!-- Message d'erreur -->
  <div class="state-error" *ngIf="error() as err">
    <shared-badge variant="danger" tone="soft">{{ err | t }}</shared-badge>
  </div>

  <!-- Ã‰tat vide -->
  <shared-empty-state
    *ngIf="myEvents().length === 0 && publicEvents().length === 0 && !error()"
    [icon]="'ğŸ”'"
    [title]="'events.empty' | t"
    [subtitle]="'Essayez d\'ajuster vos filtres ou revenez plus tard'"
    [actionLabel]="(searchInput || selectedLangCodes.length > 0) ? ('events.filters.reset' | t) : null"
    (action)="resetSearch()">
  </shared-empty-state>

  <!-- Section "Mes Ã©vÃ©nements" -->
  <section class="my-events-section" *ngIf="myEvents().length > 0">
    <div class="section-header">
      <h2 class="section-title">{{ 'events.my_events' | t }}</h2>
      <button
        type="button"
        class="collapse-button"
        (click)="toggleMyEventsSection()"
        [attr.aria-expanded]="!isMyEventsSectionCollapsed()"
        [attr.aria-label]="isMyEventsSectionCollapsed() ? 'Afficher mes Ã©vÃ©nements' : 'Masquer mes Ã©vÃ©nements'">
        <span class="collapse-icon" [class.collapsed]="isMyEventsSectionCollapsed()">â–¼</span>
      </button>
    </div>

    <div class="section-content" [class.collapsed]="isMyEventsSectionCollapsed()">
      <div class="events-grid">
        <app-event-card
          *ngFor="let scoredEvent of getPaginatedEvents(myEvents(), 'my'); trackBy: trackById"
          [event]="scoredEvent.event"
          [isNearby]="false"
          [isRecommended]="false"
          [isOrganizer]="true"
          [showBookButton]="false"
          [isPaymentLoading]="paymentLoadingEventId() === scoredEvent.event.id"
          (book)="onBookEvent($event)"
          (viewDetails)="onViewDetails($event)"
          (payDraft)="onPayDraftNow($event)">
        </app-event-card>
      </div>

      <!-- Pagination for "Mes Ã©vÃ©nements" -->
      <div class="pagination" *ngIf="getTotalPages(myEvents()) > 1">
        <button
          type="button"
          class="pagination-button"
          [disabled]="myEventsCurrentPage() === 1"
          (click)="goToPage(myEventsCurrentPage() - 1, 'my', myEvents().length)">
          â€¹ PrÃ©cÃ©dent
        </button>

        <div class="pagination-pages">
          <button
            *ngFor="let page of getPageNumbers(myEvents(), 'my')"
            type="button"
            class="pagination-page"
            [class.active]="myEventsCurrentPage() === page"
            (click)="goToPage(page, 'my', myEvents().length)">
            {{ page }}
          </button>
        </div>

        <button
          type="button"
          class="pagination-button"
          [disabled]="myEventsCurrentPage() === getTotalPages(myEvents())"
          (click)="goToPage(myEventsCurrentPage() + 1, 'my', myEvents().length)">
          Suivant â€º
        </button>
      </div>
    </div>
  </section>

  <!-- Section "Tous les Ã©vÃ©nements" -->
  <section class="public-events-section" *ngIf="publicEvents().length > 0">
    <h2 class="section-title">{{ 'events.all_events' | t }}</h2>
    <div class="events-grid">
      <app-event-card
        *ngFor="let scoredEvent of getPaginatedEvents(publicEvents(), 'public'); trackBy: trackById"
        [event]="scoredEvent.event"
        [isNearby]="scoredEvent.isNearby"
        [isRecommended]="scoredEvent.isRecommended"
        [isOrganizer]="false"
        [reserved]="scoredEvent.event.alreadyBooked === true"
        [showBookButton]="false"
        (book)="onBookEvent($event)"
        (viewDetails)="onViewDetails($event)">
      </app-event-card>
    </div>

    <!-- Pagination for "Tous les Ã©vÃ©nements" -->
    <div class="pagination" *ngIf="getTotalPages(publicEvents()) > 1">
      <button
        type="button"
        class="pagination-button"
        [disabled]="publicEventsCurrentPage() === 1"
        (click)="goToPage(publicEventsCurrentPage() - 1, 'public', publicEvents().length)">
        â€¹ PrÃ©cÃ©dent
      </button>

      <div class="pagination-pages">
        <button
          *ngFor="let page of getPageNumbers(publicEvents(), 'public')"
          type="button"
          class="pagination-page"
          [class.active]="publicEventsCurrentPage() === page"
          (click)="goToPage(page, 'public', publicEvents().length)">
          {{ page }}
        </button>
      </div>

      <button
        type="button"
        class="pagination-button"
        [disabled]="publicEventsCurrentPage() === getTotalPages(publicEvents())"
        (click)="goToPage(publicEventsCurrentPage() + 1, 'public', publicEvents().length)">
        Suivant â€º
      </button>
    </div>
  </section>

  <!-- Compteur de rÃ©sultats -->
  <div class="results-count" *ngIf="myEvents().length > 0 || publicEvents().length > 0">
    <p class="count-text">
      {{ myEvents().length + publicEvents().length }} Ã©vÃ©nement{{ (myEvents().length + publicEvents().length) > 1 ? 's' : '' }} trouvÃ©{{ (myEvents().length + publicEvents().length) > 1 ? 's' : '' }}
    </p>
  </div>
</shared-container>

<!-- Modal de confirmation d'achat -->
<app-confirm-purchase
  *ngIf="confirmPopup"
  [titleKey]="'checkout.title'"
  [messageKey]="'checkout.message'"
  [buyKey]="'checkout.buy'"
  [cancelKey]="'common.cancel'"
  [priceCents]="getSelectedEventPrice()"
  [asModal]="true"
  (cancel)="closeDialog()"
  (buy)="performPurchase()">
</app-confirm-purchase>
