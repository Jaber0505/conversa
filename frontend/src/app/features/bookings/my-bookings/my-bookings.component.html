<shared-container>
  <shared-headline-bar
    [title]="'bookings.title' | t"
    [subtitle]="'bookings.subtitle' | t"
    [actionLink]="'/' + lang">
  </shared-headline-bar>

  <!-- Message d'erreur -->
  <div class="state-error" *ngIf="error() as err">
    <shared-badge variant="danger" tone="soft">{{ err | t }}</shared-badge>
  </div>

  <!-- Ã‰tat vide -->
  <shared-empty-state
    *ngIf="!loading() && items().length === 0 && !error()"
    [icon]="'ğŸ“­'"
    [title]="'bookings.empty' | t"
    [subtitle]="'bookings.empty_subtitle' | t"
    [actionLabel]="'events.title' | t"
    [actionLink]="['/', lang, 'events']">
  </shared-empty-state>

  <!-- SECTION 1: RÃ©servations en cours (bien visible) -->
  <section class="current-bookings-section" *ngIf="currentBookings().length > 0">
    <div class="section-header-highlight">
      <div class="section-icon">âš¡</div>
      <div>
        <h2 class="section-title-highlight">{{ 'bookings.current' | t }}</h2>
        <p class="section-subtitle">{{ currentBookings().length }} rÃ©servation(s) en cours</p>
      </div>
    </div>

    <div class="bookings-grid highlight-grid">
      <div *ngFor="let b of getPaginatedBookings('current'); trackBy: trackById" class="booking-card current">
        <div class="booking-card-header">
          <div class="booking-status-badge">
            <span class="status-dot" [class.pending]="b.status === 'PENDING'" [class.confirmed]="b.status === 'CONFIRMED'"></span>
            <span class="status-text">{{ ('bookings.status.' + b.status) | t }}</span>
          </div>
          <span class="booking-id">#{{ b.id }}</span>
        </div>

        <div class="booking-card-body">
          <!-- Timer pour Ã©vÃ©nements en cours -->
          <div class="time-until" *ngIf="b.status === 'CONFIRMED'">
            <span class="time-badge" [class.live]="isEventLive(b)">
              {{ isEventLive(b) ? ('bookings.live' | t) : getTimeUntilEvent(b) }}
            </span>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ“…</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.event_date' | t }}</span>
              <span class="info-value">{{ dateLabel(b.eventObject.datetime_start) }}</span>
            </div>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ‰</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.event' | t }}</span>
              <span class="info-value">{{ b.eventObject.theme }}</span>
            </div>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ“</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.location' | t }}</span>
              <span class="info-value">{{ b.eventObject.partner_name }}</span>
            </div>
          </div>

          <div class="booking-info-row price-row">
            <span class="info-icon">ğŸ’¶</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.amount' | t }}</span>
              <span class="info-value price">{{ price(b) }}</span>
            </div>
          </div>
        </div>

        <div class="booking-card-footer">
          <shared-button
            variant="outline"
            size="sm"
            type="button"
            (click)="viewEventDetails(b.eventObject.id)">
            {{ 'common.details' | t }}
          </shared-button>

          <!-- Bouton Rejoindre pour Ã©vÃ©nements en cours -->
          <shared-button
            *ngIf="b.status === 'CONFIRMED' && isEventLive(b)"
            variant="primary"
            size="sm"
            type="button"
            (click)="joinEvent(b.eventObject.id)">
            ğŸ® {{ 'bookings.join_now' | t }}
          </shared-button>

          <!-- Bouton Payer pour rÃ©servations en attente -->
          <shared-button
            *ngIf="b.status === 'PENDING'"
            variant="primary"
            size="sm"
            type="button"
            (click)="pay(b.public_id)">
            ğŸ’³ {{ 'common.pay' | t }}
          </shared-button>

          <shared-button
            *ngIf="b.status !== 'CANCELLED' && !isEventLive(b)"
            variant="outline"
            size="sm"
            type="button"
            (click)="cancel(b.public_id)">
            {{ 'common.cancel' | t }}
          </shared-button>
        </div>
      </div>
    </div>

    <!-- Pagination pour rÃ©servations en cours -->
    <div class="pagination" *ngIf="getTotalPages('current') > 1">
      <button
        type="button"
        class="pagination-button"
        [disabled]="currentPage() === 1"
        (click)="changePage('current', currentPage() - 1)">
        â€¹ {{ 'common.previous' | t }}
      </button>

      <div class="pagination-pages">
        <button
          *ngFor="let page of getPageNumbers('current')"
          type="button"
          class="pagination-page"
          [class.active]="currentPage() === page"
          (click)="changePage('current', page)">
          {{ page }}
        </button>
      </div>

      <button
        type="button"
        class="pagination-button"
        [disabled]="currentPage() === getTotalPages('current')"
        (click)="changePage('current', currentPage() + 1)">
        {{ 'common.next' | t }} â€º
      </button>
    </div>
  </section>

  <!-- SECTION 2: RÃ©servations futures -->
  <section class="future-bookings-section" *ngIf="futureBookings().length > 0">
    <div class="section-header">
      <div class="section-icon-small">ğŸ“†</div>
      <h2 class="section-title">{{ 'bookings.future' | t }}</h2>
      <span class="section-count">{{ futureBookings().length }}</span>
    </div>

    <div class="bookings-grid">
      <div *ngFor="let b of getPaginatedBookings('future'); trackBy: trackById" class="booking-card future">
        <div class="booking-card-header">
          <div class="booking-status-badge">
            <span class="status-dot confirmed"></span>
            <span class="status-text">{{ ('bookings.status.' + b.status) | t }}</span>
          </div>
          <span class="booking-id">#{{ b.id }}</span>
        </div>

        <div class="booking-card-body">
          <div class="booking-info-row">
            <span class="info-icon">ğŸ“…</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.event_date' | t }}</span>
              <span class="info-value">{{ dateLabel(b.eventObject.datetime_start) }}</span>
            </div>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ‰</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.event' | t }}</span>
              <span class="info-value">{{ b.eventObject.theme }}</span>
            </div>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ“</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.location' | t }}</span>
              <span class="info-value">{{ b.eventObject.partner_name }}</span>
            </div>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ’¶</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.amount' | t }}</span>
              <span class="info-value">{{ price(b) }}</span>
            </div>
          </div>
        </div>

        <div class="booking-card-footer">
          <shared-button
            variant="outline"
            size="sm"
            type="button"
            (click)="viewEventDetails(b.eventObject.id)">
            {{ 'common.details' | t }}
          </shared-button>

          <shared-button
            *ngIf="b.status !== 'CANCELLED'"
            variant="outline"
            size="sm"
            type="button"
            (click)="cancel(b.public_id)">
            {{ 'common.cancel' | t }}
          </shared-button>
        </div>
      </div>
    </div>

    <!-- Pagination pour rÃ©servations futures -->
    <div class="pagination" *ngIf="getTotalPages('future') > 1">
      <button
        type="button"
        class="pagination-button"
        [disabled]="futurePage() === 1"
        (click)="changePage('future', futurePage() - 1)">
        â€¹ {{ 'common.previous' | t }}
      </button>

      <div class="pagination-pages">
        <button
          *ngFor="let page of getPageNumbers('future')"
          type="button"
          class="pagination-page"
          [class.active]="futurePage() === page"
          (click)="changePage('future', page)">
          {{ page }}
        </button>
      </div>

      <button
        type="button"
        class="pagination-button"
        [disabled]="futurePage() === getTotalPages('future')"
        (click)="changePage('future', futurePage() + 1)">
        {{ 'common.next' | t }} â€º
      </button>
    </div>
  </section>

  <!-- SECTION 3: Historique (passÃ©) -->
  <section class="past-bookings-section" *ngIf="pastBookings().length > 0">
    <div class="section-header">
      <div class="section-icon-small">ğŸ“š</div>
      <h2 class="section-title">{{ 'bookings.history' | t }}</h2>
      <span class="section-count">{{ pastBookings().length }}</span>
    </div>

    <div class="bookings-grid">
      <div *ngFor="let b of getPaginatedBookings('past'); trackBy: trackById" class="booking-card past">
        <div class="booking-card-header">
          <div class="booking-status-badge">
            <span class="status-dot cancelled"></span>
            <span class="status-text">{{ ('bookings.status.' + b.status) | t }}</span>
          </div>
          <div class="history-reason">
            <shared-badge [variant]="historyBadge(b).variant" tone="soft">
              {{ historyBadge(b).label }}
            </shared-badge>
          </div>
          <span class="booking-id">#{{ b.id }}</span>
        </div>

        <div class="booking-card-body">
          <div class="booking-info-row">
            <span class="info-icon">ğŸ“…</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.event_date' | t }}</span>
              <span class="info-value">{{ dateLabel(b.eventObject.datetime_start) }}</span>
            </div>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ‰</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.event' | t }}</span>
              <span class="info-value">{{ b.eventObject.theme }}</span>
            </div>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ“</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.location' | t }}</span>
              <span class="info-value">{{ b.eventObject.partner_name }}</span>
            </div>
          </div>

          <div class="booking-info-row">
            <span class="info-icon">ğŸ’¶</span>
            <div class="info-content">
              <span class="info-label">{{ 'bookings.amount' | t }}</span>
              <span class="info-value">{{ price(b) }}</span>
            </div>
          </div>
        </div>

        <div class="booking-card-footer">
          <shared-button
            variant="outline"
            size="sm"
            type="button"
            (click)="viewEventDetails(b.eventObject.id)">
            {{ 'common.details' | t }}
          </shared-button>
        </div>
      </div>
    </div>

    <!-- Pagination pour historique -->
    <div class="pagination" *ngIf="getTotalPages('past') > 1">
      <button
        type="button"
        class="pagination-button"
        [disabled]="pastPage() === 1"
        (click)="changePage('past', pastPage() - 1)">
        â€¹ {{ 'common.previous' | t }}
      </button>

      <div class="pagination-pages">
        <button
          *ngFor="let page of getPageNumbers('past')"
          type="button"
          class="pagination-page"
          [class.active]="pastPage() === page"
          (click)="changePage('past', page)">
          {{ page }}
        </button>
      </div>

      <button
        type="button"
        class="pagination-button"
        [disabled]="pastPage() === getTotalPages('past')"
        (click)="changePage('past', pastPage() + 1)">
        {{ 'common.next' | t }} â€º
      </button>
    </div>
  </section>

  <!-- Modal de dÃ©tails -->
  <app-booking-detail
    *ngIf="showDetail"
    [booking]="selected()!"
    [eventDto]="selectedEvent()!"
    [asModal]="true"
    (close)="showDetail = false">
  </app-booking-detail>
</shared-container>
